<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Ventilo Mika</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --accent: #4895ef;
            --bg: #f0f4f8;
            --card-white: rgba(255, 255, 255, 0.9);
            --text-dark: #2b2d42;
        }
        
        body { 
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            color: var(--text-dark);
            font-family: 'Inter', -apple-system, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            overflow-x: hidden;
        }

        .main-card {
            background: var(--card-white);
            backdrop-filter: blur(15px);
            border-radius: 40px;
            padding: 30px;
            width: 100%;
            max-width: 420px;
            margin: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.4);
            animation: slideUp 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Hélice animée avec ombre portée */
        .fan-display {
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        .fan-icon {
            font-size: 3.5rem;
            color: var(--primary);
            filter: drop-shadow(0 10px 15px rgba(67, 97, 238, 0.2));
            transition: color 0.5s ease;
        }
        .spinning { animation: spin linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Status & Badge */
        .status-pill {
            font-size: 0.7rem;
            padding: 6px 14px;
            border-radius: 50px;
            background: white;
            color: var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            font-weight: 800;
            letter-spacing: 0.5px;
        }

        /* Sections & Boutons "Physiques" */
        .control-section {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 28px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .section-label {
            font-size: 0.7rem;
            font-weight: 900;
            color: #8d99ae;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 15px;
            display: block;
        }

        .btn-custom, .speed-btn {
            border-radius: 20px;
            padding: 15px;
            font-weight: 750;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 6px 12px rgba(0,0,0,0.05);
        }

        /* Effet élastique au clic */
        .btn-custom:active, .speed-btn:active {
            transform: scale(0.9) translateY(4px);
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.1);
        }

        .btn-on { 
            background: linear-gradient(135deg, #4361ee, #4895ef); 
            color: white; 
        }
        .btn-off { background: #edf2f4; color: #8d99ae; }
        .btn-light-on { background: linear-gradient(135deg, #ffbe0b, #fb5607); color: white; }

        /* Animation de sélection de vitesse */
        .speed-btn.active {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.2);
            animation: bounce 0.4s ease-out;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .hidden { display: none !important; }
        .form-select { border: none; background: #fff; font-weight: 800; border-radius: 18px; padding: 12px; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div id="configScreen" class="main-card hidden text-center">
        <h4 class="mb-4 fw-bold">Bienvenue</h4>
        <input type="text" id="accessId" class="form-control mb-3 p-3 border-0 shadow-sm rounded-4" placeholder="Access ID">
        <input type="password" id="accessSecret" class="form-control mb-4 p-3 border-0 shadow-sm rounded-4" placeholder="Access Secret">
        <button onclick="saveConfig()" class="btn btn-primary w-100 p-3 rounded-4 fw-bold">Démarrer</button>
    </div>

    <div id="controlScreen" class="main-card hidden">
        <div class="fan-display">
            <i id="fanIcon" class="fas fa-fan fan-icon"></i>
            <span id="lightBadge" class="badge bg-warning text-white rounded-pill mt-2 hidden" style="font-size: 0.6rem;">LUMIÈRE ALLUMÉE</span>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <span id="status" class="status-pill"><i class="fas fa-circle-notch fa-spin"></i> SYNC</span>
            <button onclick="clearConfig()" class="btn btn-link text-muted p-0"><i class="fas fa-cog"></i></button>
        </div>

        <select id="deviceSelect" class="form-select mb-4 shadow-sm" onchange="refreshStatus()"></select>

        <div class="control-section">
            <span class="section-label">Contrôle Moteur</span>
            <div class="row g-2 mb-3">
                <div class="col-6"><button id="pwrOn" onclick="send('fan_switch', true)" class="btn btn-custom btn-on w-100">ALLUMER</button></div>
                <div class="col-6"><button id="pwrOff" onclick="send('fan_switch', false)" class="btn btn-custom btn-off w-100">ARRÊTER</button></div>
            </div>
            
            <span class="section-label">Vitesses</span>
            <div class="row row-cols-3 g-2">
                <button data-speed="1" onclick="send('fan_speed', 1)" class="btn speed-btn">1</button>
                <button data-speed="2" onclick="send('fan_speed', 2)" class="btn speed-btn">2</button>
                <button data-speed="3" onclick="send('fan_speed', 3)" class="btn speed-btn">3</button>
                <button data-speed="4" onclick="send('fan_speed', 4)" class="btn speed-btn">4</button>
                <button data-speed="5" onclick="send('fan_speed', 5)" class="btn speed-btn">5</button>
                <button data-speed="6" onclick="send('fan_speed', 6)" class="btn speed-btn">MAX</button>
            </div>
        </div>

        <div id="lightSection" class="control-section hidden">
            <span class="section-label">Éclairage</span>
            <div class="row g-2">
                <div class="col-6"><button onclick="send('switch_led', true)" class="btn btn-custom btn-light-on w-100"><i class="fas fa-lightbulb"></i> ON</button></div>
                <div class="col-6"><button onclick="send('switch_led', false)" class="btn btn-custom btn-off w-100">OFF</button></div>
            </div>
        </div>

        <div class="control-section mb-0">
            <span class="section-label">Rotation</span>
            <div class="row g-2">
                <div class="col-6"><button onclick="send('fan_direction', 'forward')" class="btn speed-btn w-100">MODE ÉTÉ</button></div>
                <div class="col-6"><button onclick="send('fan_direction', 'reverse')" class="btn speed-btn w-100">MODE HIVER</button></div>
            </div>
        </div>
    </div>
</div>

<script>
    const statusEl = document.getElementById('status');
    const fanIcon = document.getElementById('fanIcon');

    async function apiCall(data) {
        const res = await fetch('/api/control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                accessId: localStorage.getItem('tuya_id'), 
                accessSecret: localStorage.getItem('tuya_secret'), 
                ...data 
            })
        });
        return await res.json();
    }

    async function refreshStatus() {
        const deviceId = document.getElementById('deviceSelect').value;
        if(!deviceId) return;
        
        statusEl.innerHTML = '<i class="fas fa-sync fa-spin"></i>';

        const [schema, statusData] = await Promise.all([
            apiCall({ action: 'getSchema', deviceId }),
            apiCall({ action: 'getStatus', deviceId })
        ]);

        if(schema.success) {
            const hasLight = (schema.result.functions || []).some(f => f.code === 'switch_led');
            document.getElementById('lightSection').classList.toggle('hidden', !hasLight);
        }

        if(statusData.success) {
            const states = statusData.result;
            const isOn = states.find(s => s.code === 'fan_switch')?.value === true;
            const speed = states.find(s => s.code === 'fan_speed')?.value || 1;
            const lightOn = states.find(s => s.code === 'switch_led')?.value;

            // Animation fluide
            fanIcon.className = 'fas fa-fan fan-icon' + (isOn ? ' spinning' : '');
            if(isOn) fanIcon.style.animationDuration = (3.5 - (speed * 0.5)) + 's';
            
            // État des boutons
            document.querySelectorAll('.speed-btn').forEach(b => {
                b.classList.toggle('active', b.getAttribute('data-speed') == speed);
            });

            document.getElementById('lightBadge').classList.toggle('hidden', !lightOn);
            statusEl.innerHTML = '<i class="fas fa-check"></i> CONNECTÉ';
        }
    }

    async function send(code, value) {
        const deviceId = document.getElementById('deviceSelect').value;
        statusEl.innerHTML = '<i class="fas fa-paper-plane"></i>';
        const data = await apiCall({ action: 'send', deviceId, code, value });
        if(data.success) setTimeout(refreshStatus, 800);
    }

    async function init() {
        if (!localStorage.getItem('tuya_id')) {
            document.getElementById('configScreen').classList.remove('hidden');
            return;
        }
        document.getElementById('controlScreen').classList.remove('hidden');
        
        const data = await apiCall({ action: 'listDevices' });
        if (data.success) {
            const select = document.getElementById('deviceSelect');
            select.innerHTML = data.result.map(d => `<option value="${d.id}">${d.name.toUpperCase()}</option>`).join('');
            refreshStatus();
            setInterval(refreshStatus, 15000);
        }
    }

    function saveConfig() {
        localStorage.setItem('tuya_id', document.getElementById('accessId').value);
        localStorage.setItem('tuya_secret', document.getElementById('accessSecret').value);
        location.reload();
    }
    function clearConfig() { if(confirm("Déconnexion ?")) { localStorage.clear(); location.reload(); } }

    init();
</script>
</body>
</html>
