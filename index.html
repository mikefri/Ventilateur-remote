<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventilo Mika Pro Max</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #4361ee; --bg: #f0f4f8; --text: #2b2d42; }
        body { background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%); color: var(--text); font-family: 'Inter', sans-serif; min-height: 100vh; padding: 20px 0; }
        .main-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border-radius: 40px; padding: 25px; width: 100%; max-width: 450px; margin: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.1); }
        
        /* Animations */
        .fan-icon { font-size: 3rem; color: var(--primary); transition: all 0.5s ease; }
        .spinning { animation: spin linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Sections */
        .control-section { background: white; border-radius: 25px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .section-label { font-size: 0.7rem; font-weight: 800; color: #8d99ae; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; display: block; }
        
        /* Boutons Physiques */
        .btn-custom, .speed-btn { border-radius: 15px; border: none; font-weight: 700; transition: all 0.2s ease; padding: 12px; }
        .btn-custom:active, .speed-btn:active { transform: scale(0.92); }
        .btn-on { background: var(--primary); color: white; }
        .btn-off { background: #edf2f4; color: #8d99ae; }
        .speed-btn.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3); }

        /* Sliders */
        .form-range::-webkit-slider-runnable-track { background: #edf2f4; height: 8px; border-radius: 5px; }
        .form-range::-webkit-slider-thumb { background: var(--primary); margin-top: -4px; }

        .hidden { display: none !important; }
        .mode-btn { font-size: 0.8rem; background: #f8f9fa; border: 1px solid #eee; border-radius: 10px; padding: 5px 10px; margin-right: 5px; }
        .mode-btn.active { background: #ffbe0b; color: white; border-color: #ffbe0b; }
    </style>
</head>
<body>

<div class="container">
    <div id="controlScreen" class="main-card">
        <div class="text-center mb-3">
            <i id="fanIcon" class="fas fa-fan fan-icon"></i>
            <div id="timerDisplay" class="small text-muted mt-2 hidden"><i class="far fa-clock"></i> Fin dans : <span id="timeLeft">0</span> min</div>
        </div>

        <div class="d-flex justify-content-between mb-3">
            <span id="status" class="badge rounded-pill bg-white text-primary shadow-sm p-2 px-3">SYNC...</span>
            <select id="deviceSelect" class="form-select form-select-sm w-50 border-0 shadow-sm" onchange="refreshStatus()"></select>
        </div>

        <div class="control-section">
            <span class="section-label">Moteur & Vitesses</span>
            <div class="row g-2 mb-3">
                <div class="col-6"><button onclick="send('fan_switch', true)" class="btn btn-custom btn-on w-100">ON</button></div>
                <div class="col-6"><button onclick="send('fan_switch', false)" class="btn btn-custom btn-off w-100">OFF</button></div>
            </div>
            <div class="row row-cols-6 g-1">
                <div class="col" v-for="n in 6"><button data-speed="1" onclick="send('fan_speed', 1)" class="btn speed-btn w-100">1</button></div>
                <div class="col"><button data-speed="2" onclick="send('fan_speed', 2)" class="btn speed-btn w-100">2</button></div>
                <div class="col"><button data-speed="3" onclick="send('fan_speed', 3)" class="btn speed-btn w-100">3</button></div>
                <div class="col"><button data-speed="4" onclick="send('fan_speed', 4)" class="btn speed-btn w-100">4</button></div>
                <div class="col"><button data-speed="5" onclick="send('fan_speed', 5)" class="btn speed-btn w-100">5</button></div>
                <div class="col"><button data-speed="6" onclick="send('fan_speed', 6)" class="btn speed-btn w-100">6</button></div>
            </div>
        </div>

        <div id="lightSection" class="control-section hidden">
            <span class="section-label">Lumière & Ambiance</span>
            <div class="row g-2 mb-3">
                <div class="col-6"><button onclick="send('switch_led', true)" class="btn btn-custom btn-on w-100" style="background:#ffbe0b">Lumière ON</button></div>
                <div class="col-6"><button onclick="send('switch_led', false)" class="btn btn-custom btn-off w-100">OFF</button></div>
            </div>
            
            <div class="mb-3">
                <label class="section-label">Luminosité</label>
                <input type="range" class="form-range" min="10" max="1000" onchange="send('bright_value', parseInt(this.value))">
            </div>

            <div class="mb-3">
                <label class="section-label">Température (Chaud/Froid)</label>
                <input type="range" class="form-range" min="0" max="1000" onchange="send('temp_value', parseInt(this.value))">
            </div>

            <div class="d-flex overflow-auto pb-2">
                <button onclick="send('work_mode', 'white')" class="mode-btn">Solaire</button>
                <button onclick="send('work_mode', 'scene')" class="mode-btn">Scène</button>
                <button onclick="send('work_mode', 'music')" class="mode-btn">Musique ♫</button>
            </div>
        </div>

        <div class="control-section mb-0">
            <div class="row">
                <div class="col-6">
                    <span class="section-label">Direction</span>
                    <div class="d-flex gap-1">
                        <button onclick="send('fan_direction', 'forward')" class="btn btn-off btn-sm flex-grow-1">Été</button>
                        <button onclick="send('fan_direction', 'reverse')" class="btn btn-off btn-sm flex-grow-1">Hiver</button>
                    </div>
                </div>
                <div class="col-6">
                    <span class="section-label">Minuteur (Min)</span>
                    <select class="form-select form-select-sm" onchange="send('countdown_left_fan', parseInt(this.value))">
                        <option value="0">OFF</option>
                        <option value="60">1h</option>
                        <option value="120">2h</option>
                        <option value="240">4h</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const statusEl = document.getElementById('status');
    const fanIcon = document.getElementById('fanIcon');

    async function apiCall(data) {
        const res = await fetch('/api/control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                accessId: localStorage.getItem('tuya_id'), 
                accessSecret: localStorage.getItem('tuya_secret'), 
                ...data 
            })
        });
        return await res.json();
    }

    async function refreshStatus() {
        const deviceId = document.getElementById('deviceSelect').value;
        if(!deviceId) return;
        
        const [schema, statusData] = await Promise.all([
            apiCall({ action: 'getSchema', deviceId }),
            apiCall({ action: 'getStatus', deviceId })
        ]);

        if(schema.success) {
            const hasLight = (schema.result.functions || []).some(f => f.code === 'switch_led');
            document.getElementById('lightSection').classList.toggle('hidden', !hasLight);
        }

        if(statusData.success) {
            const states = statusData.result;
            const isOn = states.find(s => s.code === 'fan_switch')?.value === true;
            const speed = states.find(s => s.code === 'fan_speed')?.value || 1;
            const timer = states.find(s => s.code === 'countdown_left_fan')?.value;

            // Animation
            fanIcon.className = 'fas fa-fan fan-icon' + (isOn ? ' spinning' : '');
            if(isOn) fanIcon.style.animationDuration = (4 - (speed * 0.5)) + 's';
            
            // Vitesses
            document.querySelectorAll('.speed-btn').forEach(b => {
                b.classList.toggle('active', b.getAttribute('data-speed') == speed);
            });

            // Minuteur
            if(timer > 0) {
                document.getElementById('timerDisplay').classList.remove('hidden');
                document.getElementById('timeLeft').innerText = timer;
            } else {
                document.getElementById('timerDisplay').classList.add('hidden');
            }

            statusEl.innerText = 'CONNECTÉ';
        }
    }

    async function send(code, value) {
        const deviceId = document.getElementById('deviceSelect').value;
        statusEl.innerText = 'ENVOI...';
        await apiCall({ action: 'send', deviceId, code, value });
        setTimeout(refreshStatus, 1000);
    }

    async function init() {
        if (!localStorage.getItem('tuya_id')) return alert("Configure les clés d'abord");
        const data = await apiCall({ action: 'listDevices' });
        if (data.success) {
            const select = document.getElementById('deviceSelect');
            select.innerHTML = data.result.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            refreshStatus();
            setInterval(refreshStatus, 20000);
        }
    }

    init();
</script>
</body>
</html>
